<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Візуалізатор повітряних маршрутів UA (Демо)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root {
      --bg: #202023;
      --panel: #151518;
      --accent: #F20519;
      --text: #EAEAF0;
      --muted: #9A9AA3;
      --glass: rgba(255, 255, 255, 0.06);
    }
    html, body { height: 100%; margin: 0; font-family: Inter, system-ui; background: var(--bg); color: var(--text); }
    #map { height: 100%; width: 100%; background: var(--bg); }
    .neon { filter: drop-shadow(0 0 6px var(--accent)) drop-shadow(0 0 16px var(--accent)); }
    .pulse { animation: pulse 2.2s ease-in-out infinite; }
    @keyframes pulse { 0% { opacity: 0.85; } 50% { opacity: 1; } 100% { opacity: 0.85; } }
    .bottom { position: fixed; left: 0; right: 0; bottom: 0; z-index: 1000; background: linear-gradient(180deg, rgba(32, 32, 35, 0), rgba(32, 32, 35, 0.9)); backdrop-filter: blur(10px); display: flex; gap: 10px; align-items: center; padding: 14px 16px; }
    .btn { background: var(--glass); border: 1px solid rgba(255, 255, 255, 0.12); color: var(--text); padding: 10px 14px; border-radius: 14px; cursor: pointer; font-weight: 600; transition: 0.25s ease; }
    .btn:hover { box-shadow: inset 0 0 0 1px var(--accent); }
    .btn.primary { background: linear-gradient(180deg, rgba(242, 5, 25, 0.25), rgba(242, 5, 25, 0.12)); border-color: rgba(242, 5, 25, 0.6); }
    .btn.ghost { background: transparent; }
    .status { position: fixed; left: 14px; top: 14px; z-index: 1000; background: rgba(21, 21, 24, 0.85); padding: 10px 14px; border-radius: 14px; }
    .panel { position: fixed; right: 14px; top: 14px; z-index: 1001; width: 340px; background: rgba(21, 21, 24, 0.92); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 18px; padding: 14px; display: none; }
    .panel h3 { margin: 4px 0 10px; }
    .row { margin-bottom: 10px; }
    .row label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    .row input, .row select { width: 100%; padding: 10px 12px; border-radius: 14px; border: 1px solid rgba(255, 255, 255, 0.12); background: #1B1B20; color: var(--text); }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .modal { position: fixed; inset: 0; z-index: 1002; display: none; align-items: center; justify-content: center; background: rgba(0, 0, 0, 0.6); }
    .modal .box { background: #151518; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 18px; padding: 18px; width: 320px; }
    .leaflet-control-attribution { display: none; }
    .route-line { stroke: white; stroke-width: 2; stroke-dasharray: 10, 10; filter: drop-shadow(0 0 4px var(--accent)) drop-shadow(0 0 8px var(--accent)); opacity: 0.9; }
    .rotatable-icon { transition: transform 0.5s ease; transform-origin: center center; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="status" id="status">Готово</div>

<div class="bottom">
  <select id="filter" class="btn ghost">
    <option value="all">Показати: всі</option>
    <option value="shahed">Лише шахеди</option>
    <option value="rocket">Лише ракети</option>
  </select>
  <button class="btn ghost" id="previewBtn">Показати маршрут</button>
  <button class="btn" id="helpBtn">Довідка</button>
  <div style="flex: 1"></div>
  <button class="btn primary" id="adminBtn">Вхід адміністратора</button>
</div>

  <div class="panel" id="adminPanel" style="display:none">
    <h3>Адмін‑панель</h3>
    <div class="row">
      <label>Тип</label>
      <select id="type">
        <option value="shahed">Shahed</option>
        <option value="rocket">Rocket</option>
      </select>
    </div>
    <div class="row">
      <label>Швидкість (симуляція)</label>
      <input id="speed" type="number" value="180" />
    </div>
    <div class="row">
      <label>Маршрут</label>
      <select id="route">
        <option value="direct">Прямий</option>
        <option value="curve">Плавний</option>
        <option value="zigzag">Зигзаг</option>
      </select>
    </div>
    <div class="actions">
      <button class="btn primary" id="spawn">Створити</button>
      <button class="btn" id="delete" disabled>Видалити вибраний</button>
      <button class="btn" id="pause">Пауза/Продовжити</button>
      <button class="btn" id="clear">Очистити все</button>
    </div>
    <p style="color: var(--muted); font-size: 12px">Клік: старт → ціль. Клік по об'єкту — вибір.</p>
  </div>

<div class="modal" id="login">
  <div class="box">
    <h3>Вхід адміністратора</h3>
    <div class="row">
      <label>Пароль</label>
      <input id="pass" type="password" />
    </div>
    <div class="actions">
      <button class="btn primary" id="loginBtn">Увійти</button>
      <button class="btn" id="cancel">Скасувати</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  // Ваш новый конфиг Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyD3ee05hVe-raPVXFTJUYIPo-xq6tTVAJ8",
    authDomain: "ukraine-radar.firebaseapp.com",
    databaseURL: "https://ukraine-radar-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ukraine-radar",
    storageBucket: "ukraine-radar.firebasestorage.app",
    messagingSenderId: "300946505688",
    appId: "1:300946505688:web:f2d28e5f95780ff344fcad"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const entitiesCol = collection(db, 'entities');

  // Иконки и карта как у вас
  const ADMIN_PASSWORD = 'Ntvf2011';
  const statusEl = document.getElementById('status');
  const setStatus = t => statusEl.textContent = t;
  const map = L.map('map').setView([49, 31], 6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 18 }).addTo(map);
  const bounds = L.latLngBounds([44, 22], [52.5, 41]);
  map.setMaxBounds(bounds);
  map.on('drag', () => map.panInsideBounds(bounds, { animate: false }));
  const adminPanel = document.getElementById('adminPanel');
  const login = document.getElementById('login');

  let spawnMode = false, stage = 0, start = null, paused = false;
  const entities = [];
  let selected = null;

  function calculateBearing(from, to) {
    const lat1 = from.lat * Math.PI / 180;
    const lat2 = to.lat * Math.PI / 180;
    const dLon = (to.lng - from.lng) * Math.PI / 180;
    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let bearing = Math.atan2(y, x) * 180 / Math.PI;
    return (bearing + 360) % 360;
  }

  function iconFor(type, bearing = 0) {
    const img = type === 'shahed' ? 'shahed.png' : 'rocket.png';
    const size = 38;
    const html = `<img src="${img}" style="width:${size}px; transform: rotate(${bearing}deg);" class="neon pulse rotatable-icon" />`;
    return L.divIcon({ html, iconSize: [size, size], className: '' });
  }

  function updateIconRotation(marker, bearing) {
    const icon = marker.getElement();
    if (icon) {
      const img = icon.querySelector('img');
      if (img) img.style.transform = `rotate(${bearing}deg)`;
    }
  }

  function pathBuild(a, b, mode) {
    if (mode === 'curve') { const m = L.latLng((a.lat+b.lat)/2+0.35, (a.lng+b.lng)/2); return [a,m,b]; }
    if (mode === 'zigzag') { const m1=L.latLng((a.lat+b.lat)/2+0.25,(a.lng+b.lng)/2-0.35), m2=L.latLng((a.lat+b.lat)/2-0.25,(a.lng+b.lng)/2+0.35); return [a,m1,m2,b]; }
    return [a,b];
  }

  // Синхронизированная анимация через Firestore
  import { updateDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
  async function animate(ent) {
    let lastTime = null;
    let totalDistance = 0;
    for(let i=0;i<ent.path.length-1;i++) totalDistance+=map.distance(ent.path[i],ent.path[i+1]);
    let traveled = ent.traveled || 0;
    ent.i = ent.i || 0;
    ent.segmentStartDistance = ent.segmentStartDistance || 0;
    let pausedRemote = false;
    async function move(currentTime) {
      if(!lastTime) lastTime=currentTime;
      if(paused || pausedRemote || ent.i>=ent.path.length-1){ if(ent.i<ent.path.length-1) ent.animationId=requestAnimationFrame(move); return; }
      const deltaTime=(currentTime-lastTime)/1000; lastTime=currentTime;
      const distance=ent.speed*(deltaTime/3600); let remaining=distance*1000;
      while(remaining>0&&ent.i<ent.path.length-1){
        const fromPoint=ent.path[ent.i], toPoint=ent.path[ent.i+1];
        const segmentDistance=map.distance(fromPoint,toPoint);
        const segmentTraveled=traveled-ent.segmentStartDistance||0;
        if(segmentTraveled+remaining<=segmentDistance){
          const ratio=(segmentTraveled+remaining)/segmentDistance;
          const lat=fromPoint.lat+(toPoint.lat-fromPoint.lat)*ratio;
          const lng=fromPoint.lng+(toPoint.lng-fromPoint.lng)*ratio;
          ent.marker.setLatLng([lat,lng]);
          updateIconRotation(ent.marker,calculateBearing(fromPoint,toPoint));
          traveled+=remaining; remaining=0;
        } else {
          ent.marker.setLatLng(toPoint);
          if(ent.i+1<ent.path.length-1) updateIconRotation(ent.marker,calculateBearing(toPoint,ent.path[ent.i+2]));
          remaining-=(segmentDistance-segmentTraveled); traveled+=(segmentDistance-segmentTraveled); ent.i++;
          ent.segmentStartDistance=traveled;
        }
      }
      // Сохраняем текущее положение и прогресс в Firestore
      try {
        await updateDoc(doc(db, 'entities', ent.id), {
          current: ent.marker.getLatLng(),
          i: ent.i,
          traveled: traveled,
          segmentStartDistance: ent.segmentStartDistance,
          lastUpdate: Date.now(),
          paused: paused
        });
      } catch(e) {}
      if(ent.i<ent.path.length-1) ent.animationId=requestAnimationFrame(move);
    }
    if(ent.path.length>1) updateIconRotation(ent.marker,calculateBearing(ent.path[0],ent.path[1]));
    ent.animationId=requestAnimationFrame(move);
  }

  function showRouteFromCurrent(ent){
    if(ent.routeLine) map.removeLayer(ent.routeLine);
    const cur=ent.marker.getLatLng();
    const remainingPath=[cur,...ent.path.slice(ent.i+1)];
    ent.routeLine=L.polyline(remainingPath,{color:'white',weight:2,dashArray:'10,10',className:'route-line'}).addTo(map);
  }

  map.on('click', async e => {
    if(!spawnMode) return;
    if(stage===0){ start=e.latlng; stage=1; setStatus('Виберіть ціль'); }
    else{
      const end=e.latlng; spawnMode=false; stage=0;
      const type=document.getElementById('type').value;
      const speed=Number(document.getElementById('speed').value)||(type==='rocket'?900:180);
      const route=document.getElementById('route').value;
      const path=pathBuild(start,end,route);
      const initialBearing=path.length>1?calculateBearing(path[0],path[1]):0;
      const marker=L.marker(start,{icon:iconFor(type,initialBearing)}).addTo(map);
      marker.bindPopup(type==='shahed'?'Шахед':'Ракета');
      const ent={id:crypto.randomUUID(),type,marker,path,speed,i:0,routeLine:null,currentBearing:initialBearing};
      marker.on('click',()=>{selected=ent; document.getElementById('delete').disabled=false; marker.openPopup();});
      entities.push(ent);
      animate(ent);
      setStatus('Додано');

      // Сохраняем в Firebase с начальными параметрами для синхронизации
      await addDoc(entitiesCol,{
        id: ent.id,
        type: ent.type,
        speed: ent.speed,
        path: ent.path.map(p=>({lat:p.lat,lng:p.lng})),
        current: { lat: start.lat, lng: start.lng },
        i: 0,
        traveled: 0,
        segmentStartDistance: 0,
        lastUpdate: Date.now(),
        paused: false
      });
    }
  });

  // Подписка на изменения в Firestore
  onSnapshot(entitiesCol, snapshot=>{
    snapshot.docChanges().forEach(change=>{
      if(change.type==='added'||change.type==='modified'){
        const data=change.doc.data();
        let ent=entities.find(e=>e.id===data.id);
        const path=data.path.map(p=>L.latLng(p.lat,p.lng));
        const initialBearing=path.length>1?calculateBearing(path[0],path[1]):0;
        if(!ent){
          const marker=L.marker(data.current||path[0],{icon:iconFor(data.type,initialBearing)}).addTo(map);
          marker.bindPopup(data.type==='shahed'?'Шахед':'Ракета');
          ent={id:data.id,type:data.type,marker,path,speed:data.speed,i:data.i||0,routeLine:null,currentBearing:initialBearing,traveled:data.traveled||0,segmentStartDistance:data.segmentStartDistance||0};
          marker.on('click',()=>{selected=ent; document.getElementById('delete').disabled=false; marker.openPopup();});
          entities.push(ent);
          animate(ent);
        } else {
          // Обновляем положение и прогресс
          if(data.current) ent.marker.setLatLng(data.current);
          ent.i = data.i||0;
          ent.traveled = data.traveled||0;
          ent.segmentStartDistance = data.segmentStartDistance||0;
        }
      }
      if(change.type==='removed'){
        const data=change.doc.data();
        const idx=entities.findIndex(e=>e.id===data.id);
        if(idx>-1){
          const ent=entities[idx];
          cancelAnimationFrame(ent.animationId);
          map.removeLayer(ent.marker);
          if(ent.routeLine) map.removeLayer(ent.routeLine);
          entities.splice(idx,1);
        }
      }
    });
  });

  // Админ-панель и кнопки: вход только для управления
  document.getElementById('adminBtn').onclick=()=>login.style.display='flex';
  document.getElementById('cancel').onclick=()=>login.style.display='none';
  document.getElementById('loginBtn').onclick=()=>{
    if(document.getElementById('pass').value===ADMIN_PASSWORD){
      adminPanel.style.display='block'; login.style.display='none'; setStatus('Адмін активний');
    } else alert('Невірний пароль');
  };
  // Кнопки управления доступны только если админ-панель открыта
  document.getElementById('spawn').onclick=()=>{if(adminPanel.style.display==='block'){spawnMode=true; stage=0; setStatus('Клікніть старт');}};
  document.getElementById('pause').onclick=()=>{if(adminPanel.style.display==='block'){paused=!paused; setStatus(paused?'Пауза':'Продовжено');}};
  document.getElementById('clear').onclick=async ()=>{
    if(adminPanel.style.display!=='block') return;
    entities.forEach(e=>{ cancelAnimationFrame(e.animationId); map.removeLayer(e.marker); if(e.routeLine) map.removeLayer(e.routeLine); });
    entities.length=0;
    setStatus('Очищено');
    // Удалить все объекты из Firestore
    const qSnap = await getDocs(entitiesCol);
    qSnap.forEach(docSnap=>deleteDoc(doc(db,'entities',docSnap.id)));
  };
  document.getElementById('delete').onclick=async ()=>{
    if(adminPanel.style.display!=='block') return;
    if(!selected) return;
    cancelAnimationFrame(selected.animationId);
    map.removeLayer(selected.marker);
    if(selected.routeLine) map.removeLayer(selected.routeLine);
    await deleteDoc(doc(db,'entities',selected.id));
    const i=entities.indexOf(selected); if(i>-1) entities.splice(i,1);
    selected=null; document.getElementById('delete').disabled=true;
    setStatus('Видалено');
  };
  document.getElementById('previewBtn').onclick=()=>{if(!entities.length){setStatus('Немає об\'єктів');return;} entities.forEach(e=>showRouteFromCurrent(e)); setStatus('Маршрути показано');};
  document.getElementById('filter').onchange=e=>{
    const v=e.target.value;
    entities.forEach(ent=>{
      const show=v==='all'||ent.type===v;
      if(show){ map.addLayer(ent.marker); if(ent.routeLine) map.addLayer(ent.routeLine);}
      else { map.removeLayer(ent.marker); if(ent.routeLine) map.removeLayer(ent.routeLine);}
    });
  };
  document.getElementById('helpBtn').onclick=()=>alert('Демо‑візуалізація.\nКлік по об\'єкту показує тип.\nАдмін може видаляти об\'єкти.\nІконки повертаються в напрямку руху.');
</script>
</body>
</html>

