<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Territorial.io –ö–ª–æ–Ω</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
        }

        #menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            padding: 20px;
        }

        .menu-container {
            background: rgba(0, 0, 0, 0.7);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 2px solid #00b4d8;
            box-shadow: 0 0 30px rgba(0, 180, 216, 0.3);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 30px;
            color: #00b4d8;
            text-shadow: 0 0 10px rgba(0, 180, 216, 0.5);
            font-weight: bold;
        }

        #country-name {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00b4d8;
            border-radius: 10px;
            color: white;
            margin-bottom: 25px;
            text-align: center;
            outline: none;
        }

        #play-button {
            width: 100%;
            padding: 18px;
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(45deg, #0077b6, #00b4d8);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        #play-button:active {
            transform: scale(0.95);
            background: linear-gradient(45deg, #005a8c, #008bb9);
        }

        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        #map {
            background: #1a1a2e;
            position: absolute;
            top: 0;
            left: 0;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .country-label {
            position: absolute;
            font-size: 11px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            pointer-events: none;
            white-space: nowrap;
            padding: 2px 5px;
            border-radius: 3px;
            background: rgba(0, 0, 0, 0.6);
            z-index: 11;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: auto;
            border: 2px solid #00b4d8;
            z-index: 20;
            backdrop-filter: blur(10px);
        }

        .troops-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #troops-count {
            font-weight: bold;
            color: #00b4d8;
            font-size: 18px;
        }

        #percentage-slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
        }

        #percentage-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #7209b7, #4361ee);
            border-radius: 3px;
            outline: none;
        }

        #percentage-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 3px solid #00b4d8;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        #percentage-value {
            font-weight: bold;
            color: #00b4d8;
            min-width: 45px;
            text-align: center;
            font-size: 18px;
        }

        #attack-button {
            background: linear-gradient(45deg, #f72585, #b5179e);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 5px;
        }

        #attack-button:active {
            transform: scale(0.95);
            background: linear-gradient(45deg, #d1146e, #9a1486);
        }

        #zoom-controls {
            position: absolute;
            right: 15px;
            bottom: 220px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: auto;
            z-index: 20;
        }

        .zoom-button {
            width: 55px;
            height: 55px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00b4d8;
            border-radius: 12px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
        }

        .zoom-button:active {
            transform: scale(0.9);
            background: rgba(0, 180, 216, 0.3);
        }

        #attack-indicator {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, rgba(247, 37, 133, 0.8) 0%, rgba(247, 37, 133, 0) 70%);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 15;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        #stats-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px;
            border-radius: 12px;
            pointer-events: auto;
            border: 2px solid #00b4d8;
            z-index: 20;
            max-height: 40vh;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        #stats-panel h3 {
            color: #00b4d8;
            margin-bottom: 10px;
            font-size: 18px;
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #stats-list {
            max-height: calc(40vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-size: 24px;
            color: #00b4d8;
        }

        #mobile-tips {
            position: absolute;
            bottom: 250px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            max-width: 90%;
            border: 1px solid #00b4d8;
            pointer-events: none;
            z-index: 20;
        }

        /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ —ç–∫—Ä–∞–Ω–∞ */
        @media (max-width: 768px) {
            .menu-container {
                padding: 25px 20px;
                margin: 20px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            #country-name {
                font-size: 16px;
                padding: 12px;
                margin-bottom: 20px;
            }
            
            #play-button {
                padding: 16px;
                font-size: 20px;
            }
            
            #controls {
                bottom: 5px;
                left: 5px;
                right: 5px;
                padding: 12px;
            }
            
            .zoom-button {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            #zoom-controls {
                right: 10px;
                bottom: 200px;
            }
            
            #stats-panel {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 12px;
            }
        }

        @media (max-height: 700px) {
            #controls {
                gap: 8px;
                padding: 10px;
            }
            
            .troops-display {
                font-size: 14px;
            }
            
            #attack-button {
                padding: 12px;
                font-size: 18px;
            }
            
            #stats-panel {
                max-height: 35vh;
            }
            
            #stats-list {
                max-height: calc(35vh - 60px);
            }
        }

        /* –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .optimized-render {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }
    </style>
</head>
<body>
    <div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã...</div>
    
    <div id="menu-screen">
        <div class="menu-container">
            <h1>üåç –¢–ï–†–†–ò–¢–û–†–ò–ê–õ–¨–ù–ê–Ø –í–û–ô–ù–ê</h1>
            <input type="text" id="country-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã" maxlength="20" autocomplete="off">
            <button id="play-button">‚ñ∂Ô∏è –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="game-container" class="optimized-render">
            <canvas id="map"></canvas>
            <div id="ui-overlay"></div>
            <div id="attack-indicator"></div>
            
            <div id="mobile-tips">
                üëÜ –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –≥—Ä–∞–Ω–∏—á–Ω—É—é —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é, –∑–∞—Ç–µ–º –ê–¢–ê–ö–û–í–ê–¢–¨
            </div>
            
            <div id="stats-panel">
                <h3>üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê</h3>
                <div id="stats-list"></div>
            </div>
            
            <div id="controls">
                <div class="troops-display">
                    <span id="player-country-name">–°—Ç—Ä–∞–Ω–∞</span>
                    <span>–í–æ–π—Å–∫–∞: <span id="troops-count">100</span></span>
                </div>
                <div id="percentage-slider-container">
                    <span>‚öîÔ∏è –ê—Ç–∞–∫–∞:</span>
                    <input type="range" id="percentage-slider" min="10" max="100" value="50" step="10">
                    <span id="percentage-value">50%</span>
                </div>
                <button id="attack-button">‚öîÔ∏è –ê–¢–ê–ö–û–í–ê–¢–¨</button>
            </div>
            
            <div id="zoom-controls">
                <button class="zoom-button" id="zoom-in">+</button>
                <button class="zoom-button" id="zoom-out">-</button>
                <button class="zoom-button" id="reset-zoom">‚åÇ</button>
            </div>
        </div>
    </div>

    <script>
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const MAP_SIZE = isMobile ? 800 : 1000;
        const CELL_SIZE = isMobile ? 16 : 20;
        const GRID_SIZE = Math.floor(MAP_SIZE / CELL_SIZE);
        const MAX_BOTS = isMobile ? 6 : 10;
        
        const BOT_NAMES = ['–§—Ä–∞–Ω—Ü–∏—è', '–ù—ñ–º–µ—á—á–∏–Ω–∞', '–Ü—Ç–∞–ª—ñ—è', '–ò—Å–ø–∞–Ω–∏—è', '–ü–æ–ª—å—â–∞', '–ß–µ—Ö—ñ—è', '–ù–æ—Ä–≤–µ–≥—ñ—è', '–®–≤–µ—Ü—ñ—è', '–ì—Ä–µ—Ü—ñ—è', '–ü–æ—Ä—Ç—É–≥–∞–ª—ñ—è'];
        const PLAYER_COLOR = '#4361ee';
        const BOT_COLORS = [
            '#f72585', '#b5179e', '#7209b7', '#560bad',
            '#480ca8', '#3a0ca3', '#3f37c9', '#4cc9f0',
            '#4895ef', '#2a9d8f'
        ];

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            player: null,
            bots: [],
            cells: null, // –ë—É–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ
            selectedCell: null,
            attackPercentage: 50,
            zoom: isMobile ? 1.2 : 1,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            lastX: 0,
            lastY: 0,
            lastAttackTime: 0,
            attackCooldown: 1500, // 1.5 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∞—Ç–∞–∫–∞–º–∏
            gameLoopId: null,
            renderOptimized: false,
            lastRenderTime: 0,
            renderInterval: 1000 / 30 // 30 FPS –º–∞–∫—Å–∏–º—É–º
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã...');
            
            const countryName = document.getElementById('country-name').value.trim();
            if (!countryName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω—ã!');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').style.display = 'flex';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è
            localStorage.setItem('countryName', countryName);
            
            // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É
            setTimeout(() => {
                // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä—É
                document.getElementById('menu-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'block';
                document.getElementById('player-country-name').textContent = countryName;
                document.getElementById('loading').style.display = 'none';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–Ω–≤–∞—Å
                const canvas = document.getElementById('map');
                const container = document.getElementById('game-container');
                canvas.width = MAP_SIZE;
                canvas.height = MAP_SIZE;
                
                // –°–æ–∑–¥–∞–µ–º –∏–≥—Ä–æ–∫–∞
                gameState.player = {
                    name: countryName,
                    color: PLAYER_COLOR,
                    borderColor: '#2a4dcc',
                    troops: 100,
                    territories: [],
                    id: 'player'
                };
                
                // –°–æ–∑–¥–∞–µ–º –±–æ—Ç–æ–≤
                gameState.bots = [];
                const usedNames = new Set();
                const usedColors = new Set([PLAYER_COLOR]);
                
                for (let i = 0; i < MAX_BOTS; i++) {
                    let name, color;
                    let attempts = 0;
                    
                    do {
                        name = BOT_NAMES[Math.floor(Math.random() * BOT_NAMES.length)];
                        attempts++;
                        if (attempts > 50) break;
                    } while (usedNames.has(name));
                    
                    do {
                        color = BOT_COLORS[Math.floor(Math.random() * BOT_COLORS.length)];
                        attempts++;
                        if (attempts > 100) break;
                    } while (usedColors.has(color));
                    
                    usedNames.add(name);
                    usedColors.add(color);
                    
                    gameState.bots.push({
                        name: name,
                        color: color,
                        borderColor: darkenColor(color, 30),
                        troops: 100,
                        territories: [],
                        lastAction: 0,
                        actionCooldown: 3000 + Math.random() * 4000,
                        id: 'bot_' + i
                    });
                }
                
                // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–µ—Ç–æ–∫
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–µ—Ç–æ–∫...');
                gameState.cells = new Array(GRID_SIZE);
                for (let y = 0; y < GRID_SIZE; y++) {
                    gameState.cells[y] = new Array(GRID_SIZE);
                    for (let x = 0; x < GRID_SIZE; x++) {
                        gameState.cells[y][x] = {
                            owner: null,
                            troops: 0,
                            x: x * CELL_SIZE,
                            y: y * CELL_SIZE
                        };
                    }
                }
                
                // –°–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞
                spawnPlayer();
                
                // –°–ø–∞–≤–Ω –±–æ—Ç–æ–≤
                spawnBots();
                
                // –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
                renderGame();
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π
                startGameLoop();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI
                updateStats();
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    document.getElementById('mobile-tips').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('mobile-tips').style.display = 'none';
                    }, 1000);
                }, 5000);
                
                console.log('–ò–≥—Ä–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!');
            }, 100);
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∞–≤–Ω –∏–≥—Ä–æ–∫–∞
        function spawnPlayer() {
            const spawnRadius = Math.floor(GRID_SIZE / 8);
            const centerX = Math.floor(GRID_SIZE / 2);
            const centerY = Math.floor(GRID_SIZE / 2);
            
            for (let y = centerY - spawnRadius; y <= centerY + spawnRadius; y++) {
                for (let x = centerX - spawnRadius; x <= centerX + spawnRadius; x++) {
                    if (x >= 0 && x < GRID_SIZE && y >= 0 && y < GRID_SIZE) {
                        if (Math.random() > 0.7) { // 30% —à–∞–Ω—Å –∑–∞–Ω—è—Ç—å –∫–ª–µ—Ç–∫—É
                            const cell = gameState.cells[y][x];
                            if (!cell.owner) {
                                cell.owner = gameState.player;
                                cell.troops = 5;
                                gameState.player.territories.push({x: x, y: y});
                            }
                        }
                    }
                }
            }
            gameState.player.troops = 100;
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∞–≤–Ω –±–æ—Ç–æ–≤
        function spawnBots() {
            const angleStep = (Math.PI * 2) / gameState.bots.length;
            const spawnDistance = Math.floor(GRID_SIZE / 3);
            const centerX = Math.floor(GRID_SIZE / 2);
            const centerY = Math.floor(GRID_SIZE / 2);
            
            gameState.bots.forEach((bot, index) => {
                const angle = angleStep * index;
                const x = Math.floor(centerX + Math.cos(angle) * spawnDistance);
                const y = Math.floor(centerY + Math.sin(angle) * spawnDistance);
                
                const spawnRadius = 2;
                for (let dy = -spawnRadius; dy <= spawnRadius; dy++) {
                    for (let dx = -spawnRadius; dx <= spawnRadius; dx++) {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
                            if (Math.random() > 0.6) { // 40% —à–∞–Ω—Å –∑–∞–Ω—è—Ç—å –∫–ª–µ—Ç–∫—É
                                const cell = gameState.cells[ny][nx];
                                if (!cell.owner) {
                                    cell.owner = bot;
                                    cell.troops = 5;
                                    bot.territories.push({x: nx, y: ny});
                                }
                            }
                        }
                    }
                }
                bot.troops = 100;
            });
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function startGameLoop() {
            if (gameState.gameLoopId) {
                cancelAnimationFrame(gameState.gameLoopId);
            }
            
            function loop() {
                const now = Date.now();
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã
                if (now - gameState.lastRenderTime >= gameState.renderInterval) {
                    updateGame();
                    renderGame();
                    gameState.lastRenderTime = now;
                }
                
                gameState.gameLoopId = requestAnimationFrame(loop);
            }
            
            gameState.gameLoopId = requestAnimationFrame(loop);
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä—ã
        function updateGame() {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–æ–π—Å–∫ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            const now = Date.now();
            if (now % 1000 < 16) { // –ü—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
                gameState.player.troops += Math.max(1, Math.floor(gameState.player.territories.length / 15));
                
                gameState.bots.forEach(bot => {
                    bot.troops += Math.max(1, Math.floor(bot.territories.length / 15));
                });
            }
            
            // –õ–æ–≥–∏–∫–∞ –±–æ—Ç–æ–≤ (—Ä–µ–∂–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
            if (now % 500 < 16) { // –ö–∞–∂–¥—ã–µ 500ms
                gameState.bots.forEach(bot => {
                    if (now - bot.lastAction > bot.actionCooldown) {
                        botAction(bot);
                        bot.lastAction = now;
                        bot.actionCooldown = 2500 + Math.random() * 3500;
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('troops-count').textContent = gameState.player.troops;
            updateStats();
        }

        // –î–µ–π—Å—Ç–≤–∏—è –±–æ—Ç–æ–≤
        function botAction(bot) {
            if (bot.territories.length === 0 || bot.troops < 10) return;
            
            const borderCells = getBorderCells(bot);
            if (borderCells.length === 0) return;
            
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –≥—Ä–∞–Ω–∏—á–Ω—É—é –∫–ª–µ—Ç–∫—É
            const randomIndex = Math.floor(Math.random() * borderCells.length);
            const targetCell = borderCells[randomIndex];
            
            if (!targetCell) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç –∞—Ç–∞–∫–∏
            const percentage = 30 + Math.random() * 50; // 30-80%
            
            if (targetCell.owner === null) {
                // –ê—Ç–∞–∫–∞ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
                attackTerritory(bot, targetCell, percentage);
            } else if (targetCell.owner !== bot && Math.random() > 0.6) {
                // –ê—Ç–∞–∫–∞ –≤—Ä–∞–≥–∞ —Å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é 40%
                attackTerritory(bot, targetCell, percentage);
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
        function getBorderCells(owner) {
            const borderCells = [];
            const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
            const checked = new Set();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–∏–º–µ—Ç—Ä —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–π –≤–ª–∞–¥–µ–ª—å—Ü–∞
            for (const territory of owner.territories) {
                const {x, y} = territory;
                
                for (const [dx, dy] of directions) {
                    const nx = x + dx;
                    const ny = y + dy;
                    
                    if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
                        const key = nx + '_' + ny;
                        if (!checked.has(key)) {
                            checked.add(key);
                            const cell = gameState.cells[ny][nx];
                            if (cell.owner !== owner) {
                                borderCells.push(cell);
                            }
                        }
                    }
                }
            }
            
            return borderCells;
        }

        // –ê—Ç–∞–∫–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
        function attackTerritory(attacker, targetCell, percentage) {
            if (!attacker || !targetCell || attacker.troops < 10) return false;
            
            const attackingTroops = Math.floor(attacker.troops * (percentage / 100));
            if (attackingTroops < 1) return false;
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–µ—Ç–∫–∏
            const cellX = Math.floor(targetCell.x / CELL_SIZE);
            const cellY = Math.floor(targetCell.y / CELL_SIZE);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –∞—Ç–∞–∫—É—é—â–µ–≥–æ —Å–æ—Å–µ–¥–Ω—è—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è
            let hasAdjacent = false;
            const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
            
            for (const [dx, dy] of directions) {
                const nx = cellX + dx;
                const ny = cellY + dy;
                
                if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
                    const neighborCell = gameState.cells[ny][nx];
                    if (neighborCell.owner === attacker) {
                        hasAdjacent = true;
                        break;
                    }
                }
            }
            
            if (!hasAdjacent) return false;
            
            attacker.troops -= attackingTroops;
            
            // –ó–∞—Ö–≤–∞—Ç —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            if (targetCell.owner === null) {
                // –ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è
                targetCell.owner = attacker;
                targetCell.troops = attackingTroops;
                attacker.territories.push({x: cellX, y: cellY});
                return true;
            } else if (targetCell.owner !== attacker) {
                // –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤—Ä–∞–≥–∞
                if (attackingTroops > targetCell.troops) {
                    const prevOwner = targetCell.owner;
                    // –£–¥–∞–ª—è–µ–º —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é —É –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞
                    const territoryIndex = prevOwner.territories.findIndex(t => 
                        t.x === cellX && t.y === cellY
                    );
                    if (territoryIndex > -1) {
                        prevOwner.territories.splice(territoryIndex, 1);
                    }
                    
                    targetCell.owner = attacker;
                    targetCell.troops = attackingTroops - targetCell.troops;
                    attacker.territories.push({x: cellX, y: cellY});
                    return true;
                } else {
                    targetCell.troops -= attackingTroops;
                    return true;
                }
            }
            
            return false;
        }

        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
        function renderGame() {
            const canvas = document.getElementById('map');
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('game-container');
            
            // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const visibleLeft = Math.max(0, -gameState.offsetX - MAP_SIZE/2);
            const visibleTop = Math.max(0, -gameState.offsetY - MAP_SIZE/2);
            const visibleWidth = Math.min(MAP_SIZE, container.clientWidth / gameState.zoom);
            const visibleHeight = Math.min(MAP_SIZE, container.clientHeight / gameState.zoom);
            
            // –û—á–∏—â–∞–µ–º –≤–µ—Å—å –∫–∞–Ω–≤–∞—Å
            ctx.fillStyle = '#1a1a2e';
            ctx.fillRect(0, 0, MAP_SIZE, MAP_SIZE);
            
            // –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏
            for (let y = 0; y < GRID_SIZE; y++) {
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = gameState.cells[y][x];
                    if (cell.owner) {
                        ctx.fillStyle = cell.owner.color;
                        ctx.fillRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        
                        // –ì—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (—Ä–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∑—É–º–µ)
                        if (gameState.zoom > 0.8) {
                            ctx.strokeStyle = cell.owner.borderColor;
                            ctx.lineWidth = 1;
                            ctx.strokeRect(x * CELL_SIZE, y * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                        }
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫–∏
            updateCountryLabels();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ —Å—Ç—Ä–∞–Ω
        function updateCountryLabels() {
            const uiOverlay = document.getElementById('ui-overlay');
            const labels = Array.from(uiOverlay.querySelectorAll('.country-label'));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–µ—Ç–æ–∫
            const allCountries = [gameState.player, ...gameState.bots];
            
            allCountries.forEach((country, index) => {
                if (country.territories.length > 0) {
                    // –ë–µ—Ä–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –¥–ª—è –º–µ—Ç–∫–∏
                    const centerX = country.territories.reduce((sum, t) => sum + t.x, 0) / country.territories.length;
                    const centerY = country.territories.reduce((sum, t) => sum + t.y, 0) / country.territories.length;
                    
                    const screenPos = worldToScreen(centerX * CELL_SIZE, centerY * CELL_SIZE);
                    
                    let label;
                    if (labels[index]) {
                        label = labels[index];
                    } else {
                        label = document.createElement('div');
                        label.className = 'country-label';
                        uiOverlay.appendChild(label);
                    }
                    
                    label.textContent = `${country.name} (${country.troops})`;
                    label.style.left = (screenPos.x - label.offsetWidth/2) + 'px';
                    label.style.top = (screenPos.y - 20) + 'px';
                    label.style.color = country.color;
                    label.style.display = gameState.zoom > 0.5 ? 'block' : 'none';
                }
            });
            
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –º–µ—Ç–∫–∏
            while (labels.length > allCountries.length) {
                const label = labels.pop();
                if (label && label.parentNode) {
                    label.parentNode.removeChild(label);
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            const statsList = document.getElementById('stats-list');
            if (!statsList) return;
            
            const allCountries = [gameState.player, ...gameState.bots]
                .filter(country => country.territories.length > 0)
                .sort((a, b) => (b.territories.length + b.troops) - (a.territories.length + a.troops));
            
            statsList.innerHTML = '';
            
            allCountries.forEach(country => {
                const item = document.createElement('div');
                item.className = 'stat-item';
                item.innerHTML = `
                    <span style="color: ${country.color}; font-weight: ${country === gameState.player ? 'bold' : 'normal'}">
                        ${country.name}
                    </span>
                    <span>${country.troops} ‚öîÔ∏è ${country.territories.length} üìç</span>
                `;
                statsList.appendChild(item);
            });
        }

        // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        function worldToScreen(worldX, worldY) {
            const container = document.getElementById('game-container');
            const screenX = container.clientWidth / 2 + (worldX - MAP_SIZE / 2 + gameState.offsetX) * gameState.zoom;
            const screenY = container.clientHeight / 2 + (worldY - MAP_SIZE / 2 + gameState.offsetY) * gameState.zoom;
            return { x: screenX, y: screenY };
        }

        function screenToWorld(screenX, screenY) {
            const container = document.getElementById('game-container');
            const worldX = (screenX - container.clientWidth / 2) / gameState.zoom - gameState.offsetX + MAP_SIZE / 2;
            const worldY = (screenY - container.clientHeight / 2) / gameState.zoom - gameState.offsetY + MAP_SIZE / 2;
            return { x: worldX, y: worldY };
        }

        // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
        function darkenColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            
            return '#' + (
                0x1000000 +
                (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255)
            ).toString(16).slice(1);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 500);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –∏–º—è
            const savedName = localStorage.getItem('countryName');
            if (savedName) {
                document.getElementById('country-name').value = savedName;
            }
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('country-name').focus();
        });

        document.getElementById('play-button').addEventListener('click', function() {
            console.log('–ö–Ω–æ–ø–∫–∞ –∏–≥—Ä–∞—Ç—å –Ω–∞–∂–∞—Ç–∞');
            this.disabled = true;
            this.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            setTimeout(() => {
                initGame();
            }, 100);
        });

        document.getElementById('country-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('play-button').click();
            }
        });

        document.getElementById('percentage-slider').addEventListener('input', (e) => {
            gameState.attackPercentage = parseInt(e.target.value);
            document.getElementById('percentage-value').textContent = gameState.attackPercentage + '%';
        });

        document.getElementById('attack-button').addEventListener('click', () => {
            if (gameState.selectedCell) {
                const now = Date.now();
                if (now - gameState.lastAttackTime >= gameState.attackCooldown) {
                    if (attackTerritory(gameState.player, gameState.selectedCell, gameState.attackPercentage)) {
                        gameState.lastAttackTime = now;
                        
                        // –ê–Ω–∏–º–∞—Ü–∏—è –∞—Ç–∞–∫–∏
                        const indicator = document.getElementById('attack-indicator');
                        const screenPos = worldToScreen(gameState.selectedCell.x, gameState.selectedCell.y);
                        indicator.style.left = (screenPos.x - 25) + 'px';
                        indicator.style.top = (screenPos.y - 25) + 'px';
                        indicator.style.opacity = '0.8';
                        
                        setTimeout(() => {
                            indicator.style.opacity = '0';
                        }, 1000);
                    }
                }
            } else {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–Ω–∏—á–Ω—É—é —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é –¥–ª—è –∞—Ç–∞–∫–∏!');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
        const canvas = document.getElementById('map');
        
        function handleCanvasClick(e) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.type.includes('touch')) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            const worldPos = screenToWorld(x, y);
            const gridX = Math.floor(worldPos.x / CELL_SIZE);
            const gridY = Math.floor(worldPos.y / CELL_SIZE);
            
            if (gridX >= 0 && gridX < GRID_SIZE && gridY >= 0 && gridY < GRID_SIZE) {
                const cell = gameState.cells[gridY][gridX];
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≥—Ä–∞–Ω–∏—á–∏—Ç –ª–∏ –∫–ª–µ—Ç–∫–∞ —Å —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–µ–π –∏–≥—Ä–æ–∫–∞
                const isBorder = isBorderCell(gridX, gridY, gameState.player);
                
                if (isBorder && cell.owner !== gameState.player) {
                    gameState.selectedCell = cell;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±–æ—Ä–∞
                    const indicator = document.getElementById('attack-indicator');
                    const screenPos = worldToScreen(cell.x, cell.y);
                    indicator.style.left = (screenPos.x - 25) + 'px';
                    indicator.style.top = (screenPos.y - 25) + 'px';
                    indicator.style.opacity = '0.5';
                    
                    // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                    document.getElementById('mobile-tips').textContent = `–í—ã–±—Ä–∞–Ω–æ: ${gameState.attackPercentage}% –≤–æ–π—Å–∫. –ù–∞–∂–º–∏—Ç–µ –ê–¢–ê–ö–û–í–ê–¢–¨!`;
                    document.getElementById('mobile-tips').style.display = 'block';
                    document.getElementById('mobile-tips').style.opacity = '1';
                } else if (cell.owner === gameState.player) {
                    alert('–≠—Ç–æ –≤–∞—à–∞ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è!');
                } else if (!isBorder) {
                    alert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä–∞–Ω–∏—á–Ω—É—é —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—é!');
                }
            }
        }

        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                handleCanvasClick(e);
            }
        }, { passive: false });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω–æ–π –∫–ª–µ—Ç–∫–∏
        function isBorderCell(x, y, owner) {
            const directions = [[0, 1], [1, 0], [0, -1], [-1, 0]];
            
            for (const [dx, dy] of directions) {
                const nx = x + dx;
                const ny = y + dy;
                
                if (nx >= 0 && nx < GRID_SIZE && ny >= 0 && ny < GRID_SIZE) {
                    const neighbor = gameState.cells[ny][nx];
                    if (neighbor.owner === owner) {
                        return true;
                    }
                }
            }
            return false;
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑—É–º–æ–º
        document.getElementById('zoom-in').addEventListener('click', () => {
            gameState.zoom = Math.min(gameState.zoom * 1.2, 3);
        });

        document.getElementById('zoom-out').addEventListener('click', () => {
            gameState.zoom = Math.max(gameState.zoom / 1.2, 0.3);
        });

        document.getElementById('reset-zoom').addEventListener('click', () => {
            gameState.zoom = isMobile ? 1.2 : 1;
            gameState.offsetX = 0;
            gameState.offsetY = 0;
        });

        // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
            canvas.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMouseX;
                const dy = e.clientY - lastMouseY;
                
                gameState.offsetX += dx / gameState.zoom;
                gameState.offsetY += dy / gameState.zoom;
                
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            canvas.style.cursor = 'default';
        });

        // –°–µ–Ω—Å–æ—Ä–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        let lastTouchDistance = 0;
        let touchStartX = 0;
        let touchStartY = 0;

        canvas.addEventListener('touchstart', function(e) {
            if (e.touches.length === 1) {
                isDragging = true;
                lastMouseX = e.touches[0].clientX;
                lastMouseY = e.touches[0].clientY;
                touchStartX = lastMouseX;
                touchStartY = lastMouseY;
            } else if (e.touches.length === 2) {
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
            }
        }, { passive: true });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            
            if (e.touches.length === 1 && isDragging) {
                const dx = e.touches[0].clientX - lastMouseX;
                const dy = e.touches[0].clientY - lastMouseY;
                
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–¥–≤–∏–≥–æ–≤
                if (Math.abs(dx) > 2 || Math.abs(dy) > 2) {
                    gameState.offsetX += dx / gameState.zoom;
                    gameState.offsetY += dy / gameState.zoom;
                    
                    lastMouseX = e.touches[0].clientX;
                    lastMouseY = e.touches[0].clientY;
                }
            } else if (e.touches.length === 2) {
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.hypot(
                    touch2.clientX - touch1.clientX,
                    touch2.clientY - touch1.clientY
                );
                
                if (lastTouchDistance > 0) {
                    const zoomFactor = currentDistance / lastTouchDistance;
                    gameState.zoom = Math.max(0.3, Math.min(3, gameState.zoom * zoomFactor));
                }
                
                lastTouchDistance = currentDistance;
            }
        }, { passive: false });

        canvas.addEventListener('touchend', function(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ —Ç–∞–ø (–∫–æ—Ä–æ—Ç–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ)
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const distance = Math.hypot(touchEndX - touchStartX, touchEndY - touchStartY);
            
            // –ï—Å–ª–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–∞–ª–µ–Ω—å–∫–æ–µ, —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ —Ç–∞–ø–æ–º, –∞ –Ω–µ –¥—Ä–∞–≥–æ–º
            if (distance < 10) {
                // –≠—Ç–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ handleCanvasClick
            }
            
            isDragging = false;
            lastTouchDistance = 0;
        }, { passive: true });

        // –ó–∞–ø—Ä–µ—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        canvas.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                renderGame();
                updateCountryLabels();
            }, 100);
        });

        // –ü–∞—É–∑–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (gameState.gameLoopId) {
                    cancelAnimationFrame(gameState.gameLoopId);
                    gameState.gameLoopId = null;
                }
            } else {
                startGameLoop();
            }
        });

        console.log('–°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É');
    </script>
</body>
</html>
